# Code Review – SuperCollider Zed Extension
**Date:** 2026-01-05 (follow-up quick pass)

Scope: quick pass over launcher (`server/launcher`), extension entry (`src`), vendored quark (`server/quark/LanguageServer.quark`), and language config; focuses on core behavior, capability alignment, and notable gaps from prior comprehensive review (2026-01-05).

## Findings
- **Process safety:** Launcher force-kills any `sclang` on startup (`pkill -9 sclang`, `server/launcher/src/main.rs:139-145`). This can terminate unrelated user sessions and risks data loss; implement a targeted/opt-in shutdown path instead. Shutdown handling also bypasses the LSP `shutdown/exit` flow and just kills the child.
- **Dev launcher selection:** Extension treats any worktree with `Cargo.toml` as dev mode and unconditionally points to `server/launcher/target/release/sc_launcher` even if it doesn’t exist (`src/lib.rs:8-19,83-95`). In non-built worktrees this yields ENOENT. Gate on file existence or a dedicated dev flag before overriding user settings/PATH.
- **Unimplemented capability:** Launcher advertises `serverStatus` and quark sends `supercollider/serverStatus` notifications (`server/launcher/src/main.rs:565`, `server/quark/LanguageServer.quark/Notifications/ServerStatusNotification.sc`). Clients log “unhandled notification”; remove or replace with standard progress reporting.
- **Document symbols mismatch:** Capability is advertised (`server/launcher/src/main.rs:546`) but provider skips `.sc` and only returns regions for `.scd` (`server/quark/LanguageServer.quark/Providers/DocumentSymbolProvider.sc`). Either implement symbols for classes or disable the capability until the client requests it and the provider is ready.
- **Error messaging:** User-facing errors are terse. Launcher-not-found guidance and check-setup output lack actionable steps (install LanguageServer quark, set launcher path/args, expected env). Improve messages in `src/lib.rs` and launcher startup logs to aid troubleshooting.
- **Config guardrails missing:** No validation script/CI hook to prevent reintroducing bad fields in `languages/SuperCollider/config.toml`. Anti-pattern is documented but unenforced.
- **Testing/CI gaps:** No automated tests or CI for launcher or quark; changes ship unverified beyond manual checks. Given the threading/UDP/HTTP surfaces, even smoke tests would help catch regressions.
- **Capability drift:** Launcher advertises on-type formatting, code lens, code action, folding, selection range, etc.; most exist, but formatting providers return `nil` unless `formatterEnabled` is toggled manually, and document symbols are stubbed. Capabilities should reflect actual behavior to avoid client confusion.
- **Log/IO volume:** Launcher logs every packet and writes multiple files (`/tmp/sc_launcher_stdin.log`, `/tmp/sclang_post.log`) without level gating; this can overwhelm stderr and disks during normal use. HTTP eval is fire-and-forget with permissive CORS on localhost; no result plumbing or auth beyond loopback.
- **Minor polish:** Duplicate comment in `run_lsp_bridge` vendored-path section; hard-coded 100ms sleeps and frequent stderr flushes add latency/noise; region-based providers return empty dictionaries when no match (selectionRange) instead of omitting, which may surprise some clients.
- **ExitStatus misuse:** Slash command uses `out.status.unwrap_or(-1) == 0` instead of `out.status.success()` (`src/lib.rs:207`); works by accident but brittle.
- **"Non Boolean in test" crash:** `FindReferencesProvider.sc:56,67` evaluates `params["context"] !? _["includeDeclaration"] ?? { false }` which can yield non-Boolean if context is nil/malformed, causing crash in `and:` condition. Coerce to Bool explicitly.
- **Initialize response race:** ID stored as string but compared as JSON value in duplicate suppression logic (`server/launcher/src/main.rs:824-827, 989-1002`); can send duplicate initialize responses. Standardize ID format.
- **Shutdown message loss:** Sender thread checks shutdown flag but exits immediately without flushing `pending_messages` queue (`server/launcher/src/main.rs:715-717`); last messages before shutdown are dropped.
- **Performance gaps:** `LSPDatabase.allMethodNames` rebuilt from scratch on first call (~500ms); no LRU cache. Completion/lookup P95 ~50-100ms (target <10ms). JSON parsing repeated 2-3× per message for logging/validation.
- **Config ergonomics:** `languages/SuperCollider/config.toml` lacks `word_characters = ["a-zA-Z0-9_?"]`; methods like `postln?` may not be recognized as single tokens.
- **Fire-and-forget eval undocumented:** HTTP `/eval` returns 202 immediately, actual execution async; results appear in Post Window seconds later. Users expect inline feedback; needs README callout and Post Window usage guide.
- **Lingering issues from prior pass:** Hardcoded absolute paths and destructive tasks in `.zed/tasks.json`, JSON injection risk in probe response, file descriptor leak in `LSPDatabase.renderMethodRange`, missing input validation across providers, and excessive debug `postln` in quark providers remain unaddressed in code. Outline/query files remain minimal.

## Recommendations
- Remove/replace `serverStatus` capability + notification; if progress is desired, adopt standard LSP progress.
- Implement graceful shutdown (propagate shutdown signal, wait for sclang, flush pending messages, avoid global `pkill`); consider a "clean restart" command instead of killing all sclang processes.
- Make dev launcher opt-in and existence-checked; fall back to user config/PATH when missing.
- Align capabilities with implementation: either deliver symbols for `.sc`/`.scd` and enable formatting, or stop advertising until supported/turned on.
- Add a config validation script and wire it into CI/pre-commit; bootstrap minimal CI to run it and any launcher smoke tests.
- Harden user-facing errors with concrete troubleshooting steps and expected configuration examples; fix `status.unwrap_or(-1)` to use `.success()`.
- Gate logging behind levels and trim default verbosity; document fire-and-forget HTTP eval behavior in README with Post Window usage guide.
- Fix "Non Boolean in test" crash: coerce `includeDeclaration` to Bool in `FindReferencesProvider.sc`.
- Standardize initialize response ID format to prevent duplicate responses.
- Add `word_characters = ["a-zA-Z0-9_?"]` to `languages/SuperCollider/config.toml` for proper token boundaries.
- Consider LRU cache for LSPDatabase to reduce lookup latency; parse JSON once per message.
- Fix prior criticals/highs: remove hardcoded absolute paths/destructive tasks in `.zed/tasks.json`; escape probe JSON with `serde_json`; close files reliably in `LSPDatabase.renderMethodRange`; validate params in providers; replace `postln` debug with structured logging.

## Low-Hanging Fix Plan
- Remove custom `serverStatus` capability/notification to stop client warnings (launcher + `Notifications/ServerStatusNotification.sc`).
- Harden dev launcher selection: only use local build when it exists; otherwise honor settings/PATH (`src/lib.rs`).
- Fix ExitStatus check: replace `out.status.unwrap_or(-1) == 0` with `out.status.success()` (`src/lib.rs:207`).
- Fix "Non Boolean in test": coerce `includeDeclaration` to Bool with `(params["context"] !? _["includeDeclaration"]) ?? false` (`FindReferencesProvider.sc:56`).
- Tame default logging: gate verbose packet/file logging behind a log level env/flag; reduce `/tmp` writes (launcher).
- Align advertised capabilities: disable document symbols/on-type formatting unless actually enabled/implemented (launcher + providers).
- Add `scripts/validate-config.sh` and wire into CI/pre-commit to guard `languages/SuperCollider/config.toml`.
- Add `word_characters = ["a-zA-Z0-9_?"]` to `languages/SuperCollider/config.toml`.
- Use `serde_json` for probe output escaping (launcher `Mode::Probe`).
- Clean `.zed/tasks.json`: remove absolute paths and destructive pkill task; inline curl with relative/portable commands.
- Document fire-and-forget eval in README: explain async behavior, Post Window usage, no inline results.
